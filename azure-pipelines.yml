# Node.js Express Web App to Linux on Azure
# Build a Node.js Express app and deploy it to Azure as a Linux web app.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

trigger:
  - thanhnv-azure2
  
variables:
  
    # Azure Resource Manager connection created during pipeline creation
    azureSubscription: '057209bb-6e88-42c1-85cf-fd5d710fe15d'
    
    # Web app name
    webAppName: 'crm-capstione-be'
    
    # Environment name
    environmentName: 'crm-capstione-be'
  
    # Agent VM image name
    vmImageName: 'ubuntu-latest'
  
stages:
  - stage: Build
    displayName: Build stage
    jobs:  
    - job: Build
      displayName: Build
      pool:
        vmImage: $(vmImageName)
        
      steps:
      - task: NodeTool@0
        inputs:
          versionSpec: '12.8.1'
        displayName: 'Install Node.js'
  
      - script: |
          npm install
          npm run prestart:prod
        displayName: 'npm install'
        
      - task: ArchiveFiles@2
        displayName: 'Archive files'
        inputs:
          rootFolderOrFile: '$(System.DefaultWorkingDirectory)'
          includeRootFolder: false
          archiveType: zip
          archiveFile: $(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip
          replaceExistingArchive: true
  
      - upload: $(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip
        artifact: drop
  
  - stage: Deploy
    displayName: Deploy stage
    dependsOn: Build
    condition: succeeded()
    jobs:
    - deployment: Deploy
      displayName: Deploy
      environment: $(environmentName)
      pool: 
        vmImage: $(vmImageName)
      strategy:
        runOnce:
          deploy:
            steps:            
            - task: AzureWebApp@1
              displayName: 'Azure Web App Deploy: crm-capstione-be'
              inputs:
                azureSubscription: $(azureSubscription)
                appType: webAppLinux
                appName: $(webAppName)
                runtimeStack: 'NODE|12.8.1'
                package: $(Pipeline.Workspace)/drop/$(Build.BuildId).zip
                startUpCommand: 'node dist/main'